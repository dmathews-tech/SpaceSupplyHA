- alias: Mars Room-Based Motion Control
  trigger:
  - platform: state
    entity_id:
    - binary_sensor.3rsb22bz_shuttle_motion
    - binary_sensor.third_reality_inc_3rms16bz_2
    - binary_sensor.3rms16bz_greenhouse_motion
    - binary_sensor.3rms16bz_galley_motion
    - binary_sensor.third_reality_inc_3rms16bz_4
    to: 'on'
  action:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ trigger.entity_id == ''binary_sensor.3rsb22bz_shuttle_motion''
          }}'
      - condition: state
        entity_id: input_boolean.p1_motion_enabled
        state: 'on'
      - condition: template
        value_template: '{% set last = states(''input_datetime.shuttle_last_play_trigger'')
          %} {% set guard = states(''input_number.lounge_trigger_guard_minutes'')
          | float(10) * 60 %} {% if last in [''unknown'',''unavailable'',''none'','''']
          %}true{% else %}{{ (as_timestamp(now()) - as_timestamp(last)) > guard }}{%
          endif %}'
      sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.shuttle_last_play_trigger
        data:
          datetime: '{{ now().strftime(''%Y-%m-%d %H:%M:%S'') }}'
      - action: script.play_pi_file
        data:
          pi_id: p1
          file_name: p1
    - conditions:
      - condition: template
        value_template: '{{ trigger.entity_id == ''binary_sensor.third_reality_inc_3rms16bz_2''
          }}'
      - condition: template
        value_template: '{% set last = states(''input_datetime.control_room_last_play_trigger'')
          %} {% set guard = states(''input_number.control_room_trigger_guard_minutes'')
          | float(10) * 60 %} {% if last in [''unknown'',''unavailable'',''none'','''']
          %}true{% else %}{{ (as_timestamp(now()) - as_timestamp(last)) > guard }}{%
          endif %}'
      sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.control_room_last_play_trigger
        data:
          datetime: '{{ now().strftime(''%Y-%m-%d %H:%M:%S'') }}'
      - if:
        - condition: state
          entity_id: input_boolean.p2_motion_enabled
          state: 'on'
        then:
        - action: script.play_pi_file
          data:
            pi_id: p2
            file_name: p2
      - if:
        - condition: state
          entity_id: input_boolean.p3_motion_enabled
          state: 'on'
        then:
        - action: script.play_pi_file
          data:
            pi_id: p3
            file_name: p3
    - conditions:
      - condition: template
        value_template: '{{ trigger.entity_id == ''binary_sensor.3rms16bz_greenhouse_motion''
          }}'
      - condition: state
        entity_id: input_boolean.p4_motion_enabled
        state: 'on'
      - condition: template
        value_template: '{% set last = states(''input_datetime.greenhouse_last_play_trigger'')
          %} {% set guard = states(''input_number.lounge_trigger_guard_minutes'')
          | float(10) * 60 %} {% if last in [''unknown'',''unavailable'',''none'','''']
          %}true{% else %}{{ (as_timestamp(now()) - as_timestamp(last)) > guard }}{%
          endif %}'
      sequence:
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.greenhouse_last_play_trigger
        data:
          datetime: '{{ now().strftime(''%Y-%m-%d %H:%M:%S'') }}'
      - action: script.play_pi_file
        data:
          pi_id: p4
          file_name: p4
    - conditions:
      - condition: template
        value_template: '{{ trigger.entity_id == ''binary_sensor.3rms16bz_galley_motion''
          }}'
      - condition: state
        entity_id: input_boolean.p5_motion_enabled
        state: 'on'
      - condition: template
        value_template: '{% set last = states(''input_datetime.galley_last_play_trigger'')
          %} {% set guard = states(''input_number.lounge_trigger_guard_minutes'')
          | float(10) * 60 %} {% if last in [''unknown'',''unavailable'',''none'','''']
          %}true{% else %}{{ (as_timestamp(now()) - as_timestamp(last)) > guard }}{%
          endif %}'
      - condition: state
        entity_id: timer.p5_play_guard
        state: idle
      - condition: state
        entity_id: timer.p5_idle_reset
        state: idle
      sequence:
      - action: timer.start
        target:
          entity_id: timer.p5_play_guard
        data:
          duration: '{{ ''%02d:%02d:00'' | format((states(''input_number.lounge_trigger_guard_minutes'')|int(10))
            // 60, (states(''input_number.lounge_trigger_guard_minutes'')|int(10))
            % 60) }}'
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.galley_last_play_trigger
        data:
          datetime: '{{ now().strftime(''%Y-%m-%d %H:%M:%S'') }}'
      - action: script.play_pi_file
        data:
          pi_id: p5
          file_name: p5
    - conditions:
      - condition: template
        value_template: '{{ trigger.entity_id == ''binary_sensor.third_reality_inc_3rms16bz_4''
          }}'
      - condition: state
        entity_id: timer.lounge_play_guard
        state: idle
      - condition: state
        entity_id: timer.lounge_idle_reset
        state: idle
      sequence:
      - action: timer.start
        target:
          entity_id: timer.lounge_play_guard
        data:
          duration: '{{ ''%02d:%02d:00'' | format((states(''input_number.lounge_trigger_guard_minutes'')|int(10))
            // 60, (states(''input_number.lounge_trigger_guard_minutes'')|int(10))
            % 60) }}'
      - action: input_datetime.set_datetime
        target:
          entity_id: input_datetime.lounge_last_play_trigger
        data:
          datetime: '{{ now().strftime(''%Y-%m-%d %H:%M:%S'') }}'
      - action: script.holodeck_play_both
  id: 2b2c6d7de53847b284d35d90ce6542ab
- id: standby_button_pending_assignment
  alias: Standby Button - Pending Assignment
  description: Placeholder until second Z-Wave button is mapped
  triggers: []
  conditions: []
  actions:
  - action: media_player.turn_off
    target:
      entity_id:
      - media_player.epson_ls800_a
      - media_player.epson_ls800_b
  mode: single
- id: lounge_guard_end_hdmi1_idle_reset
  alias: Lounge Guard End -> HDMI1 + Idle Reset
  trigger:
  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.lounge_play_guard
  action:
  - action: script.show_idle_image_a
  - action: timer.start
    target:
      entity_id: timer.lounge_idle_reset
    data:
      duration: 00:01:00
  mode: single
- id: p5_guard_end_screensaver_idle_reset
  alias: p5 Guard End -> Screensaver + Idle Reset
  trigger:
  - platform: event
    event_type: timer.finished
    event_data:
      entity_id: timer.p5_play_guard
  action:
  - action: script.play_pi_file
    data:
      pi_id: p5
      file_name: p5_screensaver
  - action: timer.start
    target:
      entity_id: timer.p5_idle_reset
    data:
      duration: 00:01:00
  mode: single
- id: projectors_on_force_hdmi1
  alias: Projectors On -> Force HDMI 1
  initial_state: false
  trigger:
  - platform: state
    entity_id: media_player.epson_ls800_a
    to: 'on'
  - platform: state
    entity_id: media_player.epson_ls800_b
    to: 'on'
  action:
  - action: media_player.select_source
    target:
      entity_id: media_player.epson_ls800_a
    data:
      source: HDMI 1
    continue_on_error: true
  - action: media_player.select_source
    target:
      entity_id: media_player.epson_ls800_b
    data:
      source: HDMI 1
    continue_on_error: true
  mode: restart
- id: fleet_pi_online_screensaver
  alias: Fleet Pi Online -> Screensaver
  trigger:
  - platform: state
    entity_id: media_player.p1
    from: unavailable
  - platform: state
    entity_id: media_player.p4
    from: unavailable
  - platform: state
    entity_id: media_player.p5
    from: unavailable
  condition: []
  action:
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ trigger.entity_id == ''media_player.p1'' }}'
      sequence:
      - action: script.play_pi_file
        data:
          pi_id: p1
          file_name: p1_screensaver
      - action: input_text.set_value
        target:
          entity_id: input_text.p1_trigger_mode
        data:
          value: Screensaver
    - conditions:
      - condition: template
        value_template: '{{ trigger.entity_id == ''media_player.p4'' }}'
      sequence:
      - action: script.play_pi_file
        data:
          pi_id: p4
          file_name: p4_screensaver
      - action: input_text.set_value
        target:
          entity_id: input_text.p4_trigger_mode
        data:
          value: Screensaver
    - conditions:
      - condition: template
        value_template: '{{ trigger.entity_id == ''media_player.p5'' }}'
      sequence:
      - action: script.play_pi_file
        data:
          pi_id: p5
          file_name: p5_screensaver
      - action: input_text.set_value
        target:
          entity_id: input_text.p5_trigger_mode
        data:
          value: Screensaver
  mode: restart
- id: projector_idle_wallpaper_watchdog
  alias: Projector Idle Wallpaper Watchdog
  initial_state: true
  trigger:
  - platform: time_pattern
    seconds: /15
  - platform: state
    entity_id: media_player.epson_ls800_a
  - platform: state
    entity_id: media_player.epson_ls800_b
  condition:
  - condition: template
    value_template: '{{ states(''timer.lounge_play_guard'') == ''idle'' }}'
  - condition: template
    value_template: '{{ states(''timer.lounge_idle_reset'') in [''idle'',''active''] }}'
  action:
  - action: script.show_idle_image_a
    continue_on_error: true
  - action: script.show_idle_image_b
    continue_on_error: true
  mode: restart
- id: launch_button_short_press_shuttle_experience
  alias: Launch Button Short Press - Shuttle Experience
  description: One-press launch button keeps Govee H6811 behavior and starts p1.mp4
    on Shuttle Left/Right HomeKit players.
  trigger:
  - platform: event
    event_type: launch_button_short_press
  condition: []
  action:
  - action: script.launch_shuttle_experience
  mode: single


- id: lounge_media_end_show_idle_images
  alias: Lounge Media End -> Idle Images
  trigger:
  - platform: state
    entity_id: media_player.epson_ls800_a
    to: idle
    for: 00:00:30
  - platform: state
    entity_id: media_player.epson_ls800_a
    to: 'off'
    for: 00:00:30
  - platform: state
    entity_id: media_player.epson_ls800_b
    to: idle
    for: 00:00:30
  - platform: state
    entity_id: media_player.epson_ls800_b
    to: 'off'
    for: 00:00:30
  condition:
  - condition: state
    entity_id: timer.lounge_play_guard
    state: idle
  action:
  - choose:
    - conditions:
      - condition: template
        value_template: "{{ trigger.entity_id == 'media_player.epson_ls800_a' }}"
      sequence:
      - action: script.show_idle_image_a
    - conditions:
      - condition: template
        value_template: "{{ trigger.entity_id == 'media_player.epson_ls800_b' }}"
      sequence:
      - action: script.show_idle_image_b
  mode: restart


- id: launch_button_double_press_shuttle_reset
  alias: Launch Button Double Press - Reset Shuttle Video
  description: Double press resets p1.mp4 playback back to the beginning on both shuttle TVs.
  trigger:
  - platform: event
    event_type: launch_button_double_press
  condition: []
  action:
  - action: script.launch_shuttle_experience_reset
  mode: restart


- id: shuttle_tvs_on_show_idle_wallpapers
  alias: Shuttle TVs On -> Show Idle Wallpapers
  trigger:
  - platform: state
    entity_id: media_player.firetv_television
    to: 'on'
  - platform: state
    entity_id: media_player.firetv_2aab23fa1b361d7b_television
    to: 'on'
  condition: []
  action:
  - delay: 00:00:02
  - action: script.shuttle_show_idle_wallpapers
  mode: restart


- id: shuttle_tvs_media_end_show_idle_wallpapers
  alias: Shuttle TVs Media End -> Show Idle Wallpapers
  trigger:
  - platform: state
    entity_id: media_player.firetv_television
    to: idle
    for: 00:00:10
  - platform: state
    entity_id: media_player.firetv_2aab23fa1b361d7b_television
    to: idle
    for: 00:00:10
  condition: []
  action:
  - action: script.shuttle_show_idle_wallpapers
  mode: restart


- id: control_room_179_wallpaper_enforce
  alias: Control Room .179 -> Enforce Wallpaper B
  trigger:
  - platform: homeassistant
    event: start
  condition: []
  action:
  - action: script.control_room_show_wallpaper_b
  mode: single


- id: launch_button_long_press_toggle_system
  alias: Launch Button Long Press - Toggle System
  description: Long press toggles full system on/off based on current device states.
  trigger:
  - platform: event
    event_type: launch_button_long_press
  condition: []
  action:
  - action: script.launch_button_long_press_toggle
  mode: restart


- id: launch_button_1_zha_bridge
  alias: Launch Button 1 ZHA -> Launch Events Bridge
  description: Maps raw Launch button ZHA commands to canonical launch_button_* events.
  trigger:
  - platform: event
    event_type: zha_event
    event_data:
      device_id: 167ab9337b4285a5d971890aa5c57ccd
  condition: []
  action:
  - choose:
    - conditions:
      - condition: template
        value_template: "{{ trigger.event.data.command == 'single' }}"
      sequence:
      - event: launch_button_short_press
        event_data:
          source: launch_button_1
          command: single
    - conditions:
      - condition: template
        value_template: "{{ trigger.event.data.command == 'double' }}"
      sequence:
      - event: launch_button_double_press
        event_data:
          source: launch_button_1
          command: double
    - conditions:
      - condition: template
        value_template: "{{ trigger.event.data.command == 'hold' }}"
      sequence:
      - event: launch_button_long_press
        event_data:
          source: launch_button_1
          command: hold
  mode: queued
  max: 10

- id: projector_bulb_hours_daily_poll
  alias: Projector Bulb Hours - Daily Poll
  description: Refresh projector lamp/laser hour counters every 24h at midnight.
  trigger:
  - platform: time
    at: "00:10:00"
  action:
  - action: homeassistant.update_entity
    target:
      entity_id:
      - sensor.projector_a_bulb_hours
      - sensor.projector_b_bulb_hours
  mode: single
